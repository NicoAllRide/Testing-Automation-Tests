name: Run Robot Framework Tests (Parallel, No Artifacts)

on:
  repository_dispatch:
    types: [trigger-workflow]
  workflow_dispatch:

concurrency:
  group: parallel-tests
  cancel-in-progress: true

jobs:

  # ============================
  #      JOB: ADMIN
  # ============================
  admin:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - run: |
          pip install robotframework robotframework-requests robotframework-seleniumlibrary rpaframework requests slack_sdk

      - run: robot -d results -o output_admin.xml "AllRide Test Cases/Test Cases/Admin"
        continue-on-error: true

      # sube archivo temporal sin ocupar storage
      - uses: actions/upload-artifact@v4
        with:
          name: admin_output
          path: results/output_admin.xml
          retention-days: 0


  # ============================
  #      JOB: CARPOOL
  # ============================
  carpool:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - run: |
          pip install robotframework websocket-client robotframework-requests robotframework-seleniumlibrary rpaframework requests slack_sdk

      - run: robot -d results -o output_carpool.xml "AllRide Test Cases/Test Cases/Carpool"
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: carpool_output
          path: results/output_carpool.xml
          retention-days: 0


  # ============================
  #      JOB: RDD
  # ============================
  rdd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - run: |
          pip install robotframework robotframework-requests robotframework-seleniumlibrary rpaframework requests slack_sdk

      - run: robot -d results -o output_rdd.xml "AllRide Test Cases/Test Cases/RDD Flow"
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: rdd_output
          path: results/output_rdd.xml
          retention-days: 0


  # ============================
  #      JOB: REGULAR + SCHED
  # ============================
  regular_and_scheduled:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: 3.8

      - run: |
          pip install robotframework robotframework-requests robotframework-seleniumlibrary rpaframework requests slack_sdk

      - run: robot -d results_regular -o output_regular.xml "AllRide Test Cases/Test Cases/Regular Flow"
        continue-on-error: true

      - run: robot -d results_sched -o output_sched.xml "AllRide Test Cases/Test Cases/Scheduled Flow/ScheduledTickets"
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: regular_outputs
          path: |
            results_regular/output_regular.xml
            results_sched/output_sched.xml
          retention-days: 0


  # ============================
  #      JOB FINAL
  # ============================
  merge_and_commit:
    runs-on: ubuntu-latest
    needs: [admin, carpool, rdd, regular_and_scheduled]

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download all outputs
        uses: actions/download-artifact@v4
        with:
          path: merged_results

      - name: Install Robot + Slack
        run: |
          pip install robotframework slack_sdk

      - name: Merge XMLs
        run: |
          rebot --output output.xml merged_results/*/*.xml

      - name: Commit merged output
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          cp output.xml output_final.xml
          git add output_final.xml

          git commit -m "Merged outputs [skip ci]" || echo "No changes"
          git push origin main

      - name: Send Slack Notification
        run: python sendTestToSlack.py
